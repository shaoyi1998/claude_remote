# Claude Remote 启动指南

## 环境要求

- Windows 11 22H2+ (支持 WSL mirrored 模式)
- WSL 2.4.0+
- Ubuntu 22.04 (或其他 Linux 发行版)
- Node.js 18+
- Python 3.10+
- tmux (`sudo apt install tmux`)

## 一、WSL 网络配置 (关键)

### 1. 配置 .wslconfig

创建或编辑 `C:\Users\{用户名}\.wslconfig`：

```ini
[wsl2]
memory=524288000000
swap=17301504000
networkingMode=mirrored
firewall=false
autoProxy=true
```

**关键配置说明：**
- `networkingMode=mirrored` - WSL 使用镜像网络模式，共享 Windows 的 IP 地址，局域网可直接访问
- `firewall=false` - 禁用 WSL 内部防火墙
- `autoProxy=true` - 自动继承 Windows 代理设置

### 2. 重启 WSL 使配置生效

```powershell
wsl --shutdown
```

等待几秒后，WSL 会自动重启，或手动启动：

```powershell
wsl -d Ubuntu-22.04
```

### 3. 验证网络配置

```bash
# 在 WSL 内检查 IP
ip addr show | grep "inet "

# 应该看到和 Windows 相同的局域网 IP（如 192.168.x.x）
```

## 二、后端启动

### 1. 安装依赖

```bash
cd /mnt/d/pycharm项目/claude_code远程/backend
pip install -r requirements.txt
```

### 2. 启动后端服务

```bash
cd /mnt/d/pycharm项目/claude_code远程/backend
python3 -m uvicorn main:app --host 0.0.0.0 --port 8000
```

### 3. 验证后端

```bash
# WSL 内测试
curl http://127.0.0.1:8000/health

# 应返回: {"status":"ok"}
```

## 三、前端启动

### 1. 安装依赖

```bash
cd /mnt/d/pycharm项目/claude_code远程/frontend
npm install
```

### 2. 启动开发服务器

```bash
npm run dev
```

前端默认运行在 `http://localhost:3000`

## 四、Windows 防火墙配置

如果局域网无法访问，需要添加防火墙规则：

```powershell
# 添加端口范围规则（管理员权限）
netsh advfirewall firewall add rule name="WSL2 Ports 8000-9000" dir=in action=allow protocol=tcp localport=8000-9000
```

或单独添加端口：

```powershell
netsh advfirewall firewall add rule name="Claude Backend 8000" dir=in action=allow protocol=tcp localport=8000
netsh advfirewall firewall add rule name="Claude Frontend 3000" dir=in action=allow protocol=tcp localport=3000
```

## 五、访问地址

启动成功后：

- **本机访问前端**: http://localhost:3000
- **局域网访问前端**: http://192.168.x.x:3000
- **后端 API**: http://192.168.x.x:8000
- **健康检查**: http://192.168.x.x:8000/health

## 六、常见问题

### 问题 1: 端口被占用

```bash
# 查找占用进程
lsof -i :8000

# 杀掉进程
kill -9 <PID>
```

### 问题 2: WSL 端口无法从 Windows 访问

确保 `.wslconfig` 中 `networkingMode=mirrored` 已配置，并重启 WSL。

### 问题 3: 局域网无法访问

1. 检查 Windows 防火墙规则
2. 确认 WSL 使用 mirrored 模式
3. 检查路由器是否隔离了局域网设备

### 问题 4: WSL 启动报错 "address already in use"

可能是 Windows 端口转发残留，清理后重启：

```powershell
# 查看端口转发规则
netsh interface portproxy show all

# 删除规则
netsh interface portproxy delete v4tov4 listenport=8000 listenaddress=0.0.0.0
```

### 问题 5: Windows 本机用局域网 IP 访问不了

这是正常现象。mirrored 模式下，Windows 用 127.0.0.1 可以访问，但用局域网 IP 可能不行。**其他电脑用局域网 IP 是可以访问的**。

## 七、一键启动脚本

### Windows 启动脚本 (start.bat)

```batch
@echo off
echo 启动 Claude Remote...

:: 启动后端
wsl -d Ubuntu-22.04 -- bash -c "cd '/mnt/d/pycharm项目/claude_code远程/backend' && python3 -m uvicorn main:app --host 0.0.0.0 --port 8000" &

:: 启动前端
cd /d "D:\pycharm项目\claude_code远程\frontend"
npm run dev

pause
```

### WSL 启动脚本 (start.sh)

```bash
#!/bin/bash
echo "启动 Claude Remote..."

# 启动后端
cd /mnt/d/pycharm项目/claude_code远程/backend
python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 &
BACKEND_PID=$!

# 启动前端
cd /mnt/d/pycharm项目/claude_code远程/frontend
npm run dev &
FRONTEND_PID=$!

echo "后端 PID: $BACKEND_PID"
echo "前端 PID: $FRONTEND_PID"
echo "按 Ctrl+C 停止所有服务"

wait
```

## 八、反向代理功能

新增的反向代理功能可以访问本地其他开发服务器：

- **用法**: `http://192.168.x.x:8000/proxy/{port}/{path}?token=xxx`
- **示例**: `http://192.168.x.x:8000/proxy/5173/?token=xxx` 访问本地 5173 端口的 Vite 服务

通过前端界面：设置 → 反向代理 → 输入端口号

## 九、依赖版本参考

```
# backend/requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
bcrypt==4.0.1
python-multipart==0.0.6
sse-starlette==1.8.2
pydantic==2.5.3
pydantic-settings==2.1.0
aiofiles==23.2.1
libtmux==0.23.2
httpx==0.27.0
websockets==12.0
```

## 十、快速检查清单

- [ ] `.wslconfig` 配置了 `networkingMode=mirrored`
- [ ] WSL 已重启 (`wsl --shutdown`)
- [ ] 后端依赖已安装 (`pip install -r requirements.txt`)
- [ ] 前端依赖已安装 (`npm install`)
- [ ] Windows 防火墙已开放端口
- [ ] 其他电脑可以访问 `http://192.168.x.x:8000/health`
